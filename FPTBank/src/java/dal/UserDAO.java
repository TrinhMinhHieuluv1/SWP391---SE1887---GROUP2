package dal;

import java.sql.Date;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.util.ArrayList;
import java.util.List;
import model.Asset;
import model.Customer;
import model.Salary;
import model.User;
import java.sql.*;
import model.Customer;

public class UserDAO extends DBContext {

    public User checkAuthen(String username, String password) {
        String sql = "SELECT * FROM [User] WHERE Username=? AND Password=?";
        try {
            PreparedStatement st = connection.prepareStatement(sql);
            st.setString(1, username);
            st.setString(2, password);
            ResultSet rs = st.executeQuery();
            while (rs.next()) {
                User user = new User(rs.getInt("UserID"),
                        rs.getString("Username"),
                        rs.getString("Password"),
                        rs.getString("FullName"),
                        rs.getString("Image"),
                        rs.getString("Phone"),
                        rs.getString("Email"),
                        rs.getDate("DateOfBirth"),
                        rs.getBoolean("Gender"),
                        rs.getString("Address"),
                        rs.getString("CCCD"),
                        rs.getInt("RoleID"),
                        rs.getBoolean("Status"),
                        getManagerForSeller(rs.getInt("ManageID")),
                        rs.getDate("CreatedAt"));
                return user;
            }
        } catch (SQLException e) {
        }
        return null;
    }

    public User getManagerForSeller(int managerID) {
        String sql = "SELECT * FROM [User] WHERE UserID=?";
        try {
            PreparedStatement st = connection.prepareStatement(sql);
            st.setInt(1, managerID);
            ResultSet rs = st.executeQuery();
            while (rs.next()) {
                User manager = new User(rs.getInt("UserID"),
                        rs.getString("Username"),
                        rs.getString("Password"),
                        rs.getString("FullName"),
                        rs.getString("Image"),
                        rs.getString("Phone"),
                        rs.getString("Email"),
                        rs.getDate("DateOfBirth"),
                        rs.getBoolean("Gender"),
                        rs.getString("Address"),
                        rs.getString("CCCD"),
                        rs.getInt("RoleID"),
                        rs.getBoolean("Status"),
                        null,
                        rs.getDate("CreatedAt"));
                return manager;
            }
        } catch (SQLException e) {
            e.printStackTrace();
        }
        return null;
    }

    // check ROLE ID cá»§a users
    public boolean isAdmin(String username, String password) {
        String sql = "select RoleID FROM [dbo].[User] where Username = ? and Password = ?";

        try {
            PreparedStatement st = connection.prepareStatement(sql);
            st.setString(1, username);
            st.setString(2, password);
            ResultSet rs = st.executeQuery();
            while (rs.next()) {
                int roleID = rs.getInt("RoleID");
                if (roleID == 1) {
                    return true;
                }
            }

        } catch (SQLException e) {
            e.printStackTrace();
        }
        return false;
    }

        
    public User selectAnUserByConditions(int UserID, String Username, String Phone, String Email) {
        String sql = "SELECT * FROM [User] WHERE 1=1";
        if (UserID != 0) {
            sql = sql + " AND UserID=" + UserID;
        }
        if (!Username.isEmpty()) {
            sql = sql + " AND Username='" + Username +"'";
        }
        if (!Phone.isEmpty()) {
            sql = sql + " AND Phone='" + Phone + "'";
        }
        if (!Email.isEmpty()) {
            sql = sql + " AND Email='" + Email + "'";
        }
        try {
            PreparedStatement st = connection.prepareStatement(sql);
            ResultSet rs = st.executeQuery();
            while (rs.next()) {
                User userToAdd = new User(rs.getInt("UserID"),
                        rs.getString("Username"),
                        rs.getString("Password"),
                        rs.getString("FullName"),
                        rs.getString("Image"),
                        rs.getString("Phone"),
                        rs.getString("Email"),
                        rs.getDate("DateOfBirth"),
                        rs.getBoolean("Gender"),
                        rs.getString("Address"),
                        rs.getString("CCCD"),
                        rs.getInt("RoleID"),
                        rs.getBoolean("Status"),
                        getManagerForSeller(rs.getInt("ManageID")),
                        rs.getDate("CreatedAt"));
                return userToAdd;
            }
        } catch (SQLException e) {
        }
        return null;
    }

    public List<User> selectAllUser() {
        List<User> userList = new ArrayList<>();
        String sql = "SELECT * FROM [User]";
        try {
            PreparedStatement st = connection.prepareStatement(sql);
            ResultSet rs = st.executeQuery();
            while (rs.next()) {
                User userToAdd = new User(rs.getInt("UserID"),
                        rs.getString("Username"),
                        rs.getString("Password"),
                        rs.getString("FullName"),
                        rs.getString("Image"),
                        rs.getString("Phone"),
                        rs.getString("Email"),
                        rs.getDate("DateOfBirth"),
                        rs.getBoolean("Gender"),
                        rs.getString("Address"),
                        rs.getString("CCCD"),
                        rs.getInt("RoleID"),
                        rs.getBoolean("Status"),
                        getManagerForSeller(rs.getInt("ManageID")),
                        rs.getDate("CreatedAt"));
                userList.add(userToAdd);
            }
        } catch (SQLException e) {
        }
        return userList;
    }

    public List<User> selectAllManager() {
        List<User> managerList = new ArrayList<>();
        String sql = "SELECT * FROM [User] WHERE RoleID=3";
        try {
            PreparedStatement st = connection.prepareStatement(sql);
            ResultSet rs = st.executeQuery();
            while (rs.next()) {
                User manager = new User(rs.getInt("UserID"),
                        rs.getString("Username"),
                        rs.getString("Password"),
                        rs.getString("FullName"),
                        rs.getString("Image"),
                        rs.getString("Phone"),
                        rs.getString("Email"),
                        rs.getDate("DateOfBirth"),
                        rs.getBoolean("Gender"),
                        rs.getString("Address"),
                        rs.getString("CCCD"),
                        rs.getInt("RoleID"),
                        rs.getBoolean("Status"),
                        null,
                        rs.getDate("CreatedAt"));
                managerList.add(manager);
            }
        } catch (SQLException e) {
        }
        return managerList;
    }

    public List<User> selectAllSeller() {
        List<User> sellerList = new ArrayList<>();
        String sql = "SELECT * FROM [User] WHERE RoleID=2";
        try {
            PreparedStatement st = connection.prepareStatement(sql);
            ResultSet rs = st.executeQuery();
            while (rs.next()) {
                User seller = new User(rs.getInt("UserID"),
                        rs.getString("Username"),
                        rs.getString("Password"),
                        rs.getString("FullName"),
                        rs.getString("Image"),
                        rs.getString("Phone"),
                        rs.getString("Email"),
                        rs.getDate("DateOfBirth"),
                        rs.getBoolean("Gender"),
                        rs.getString("Address"),
                        rs.getString("CCCD"),
                        rs.getInt("RoleID"),
                        rs.getBoolean("Status"),
                        getManagerForSeller(rs.getInt("ManageID")),
                        rs.getDate("CreatedAt"));
                sellerList.add(seller);
            }
        } catch (SQLException e) {
        }
        return sellerList;
    }

    public void addAUser(User userToAdd) {
        String sql = "INSERT INTO [User](Username, Password, FullName, Image, Phone, Email, DateOfBirth, Gender, Address, CCCD, RoleID, Status, ManageID)\n"
                + " VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)";
        try {
            PreparedStatement st = connection.prepareStatement(sql);
            st.setString(1, userToAdd.getUsername());
            st.setString(2, userToAdd.getPassword());
            st.setString(3, userToAdd.getFullName());
            st.setString(4, userToAdd.getImage());
            st.setString(5, userToAdd.getPhone());
            st.setString(6, userToAdd.getEmail());
            st.setDate(7, userToAdd.getDateOfBirth());
            st.setBoolean(8, userToAdd.isGender());
            st.setString(9, userToAdd.getAddress());
            st.setString(10, userToAdd.getCCCD());
            st.setInt(11, userToAdd.getRoleID());
            st.setBoolean(12, userToAdd.isStatus());
            if (userToAdd.getManager() != null) {
                st.setInt(13, userToAdd.getManager().getUserID());
            } else {
                st.setNull(13, Types.INTEGER);
            }
            st.executeUpdate();
        } catch (SQLException e) {
            System.out.println(e);
        }
    }

    public void updateAUserByUserID(User userToUpdate) {
        String sql = "UPDATE [User] SET Password=?, FullName=?, Image=?, Phone=?, Email=?, DateOfBirth=?, Gender=?, Address=?, CCCD=?, RoleID=?, Status=?, ManageID=? WHERE UserID=?";
        try {
            PreparedStatement st = connection.prepareStatement(sql);
            st.setString(1, userToUpdate.getPassword());
            st.setString(2, userToUpdate.getFullName());
            st.setString(3, userToUpdate.getImage());
            st.setString(4, userToUpdate.getPhone());
            st.setString(5, userToUpdate.getEmail());
            st.setDate(6, userToUpdate.getDateOfBirth());
            st.setBoolean(7, userToUpdate.isGender());
            st.setString(8, userToUpdate.getAddress());
            st.setString(9, userToUpdate.getCCCD());
            st.setInt(10, userToUpdate.getRoleID());
            st.setBoolean(11, userToUpdate.isStatus());
            if (userToUpdate.getManager() != null) {
                st.setInt(12, userToUpdate.getManager().getUserID());
            } else {
                st.setNull(12, Types.INTEGER);
            }
            st.setInt(13, userToUpdate.getUserID());
            st.executeUpdate();
        } catch (SQLException e) {
        }
    }

    public List<User> selectAllUsersByRole(int roleID) {
        List<User> userList = new ArrayList<>();
        String sql = "SELECT * FROM [TimiBank].[dbo].[User] WHERE RoleID = ?";

        try {
            PreparedStatement st = connection.prepareStatement(sql);
            st.setInt(1, roleID);
            ResultSet rs = st.executeQuery();

            while (rs.next()) {
                // Táº¡o User Manager náº¿u cÃ³ ManageID
                User manager = null;
                int managerID = rs.getInt("ManageID");
                if (!rs.wasNull()) {
                    manager = getUserByID(managerID); // Láº¥y thÃ´ng tin Manager tá»« ID
                }

                // Táº¡o Äá»i tÆ°á»£ng User tá»« dá»¯ liá»u
                User userToAdd = new User(
                        rs.getInt("UserID"),
                        rs.getString("Username"),
                        rs.getString("Password"),
                        rs.getString("FullName"),
                        rs.getString("Image"),
                        rs.getString("Phone"),
                        rs.getString("Email"),
                        rs.getDate("DateOfBirth"),
                        rs.getBoolean("Gender"),
                        rs.getString("Address"),
                        rs.getString("CCCD"),
                        rs.getInt("RoleID"),
                        rs.getBoolean("Status"),
                        manager, // Äá»i tÆ°á»£ng Manager (cÃ³ thá» null)
                        rs.getDate("CreatedAt")
                );
                userList.add(userToAdd);
            }
        } catch (SQLException e) {
            e.printStackTrace(); // Debug lá»i náº¿u cÃ³
        }
        return userList;
    }

    // HÃ m láº¥y User theo UserID (há» trá»£ láº¥y Manager)
    private User getUserByID(int userID) {
        String sql = "SELECT * FROM [TimiBank].[dbo].[User] WHERE UserID = ?";
        try {
            PreparedStatement st = connection.prepareStatement(sql);
            st.setInt(1, userID);
            ResultSet rs = st.executeQuery();
            if (rs.next()) {
                return new User(
                        rs.getInt("UserID"),
                        rs.getString("Username"),
                        rs.getString("Password"),
                        rs.getString("FullName"),
                        rs.getString("Image"),
                        rs.getString("Phone"),
                        rs.getString("Email"),
                        rs.getDate("DateOfBirth"),
                        rs.getBoolean("Gender"),
                        rs.getString("Address"),
                        rs.getString("CCCD"),
                        rs.getInt("RoleID"),
                        rs.getBoolean("Status"),
                        null, // KhÃ´ng cáº§n Äá» quy láº¥y tiáº¿p Manager
                        rs.getDate("CreatedAt")
                );
            }
        } catch (SQLException e) {
            e.printStackTrace();
        }
        return null;
    }

    public int countUsersByRole(int roleID) {
        int userCount = 0;
        String sql = "SELECT COUNT(*) FROM [TimiBank].[dbo].[User] WHERE RoleID = ?";

        try {
            PreparedStatement st = connection.prepareStatement(sql);
            st.setInt(1, roleID); // Set RoleID vÃ o cÃ¢u truy váº¥n
            ResultSet rs = st.executeQuery();

            if (rs.next()) {
                userCount = rs.getInt(1); // Láº¥y káº¿t quáº£ tá»« COUNT(*)
            }
        } catch (SQLException e) {
            e.printStackTrace(); // Debug lá»i náº¿u cÃ³
        }

        return userCount;
    }
 public User checkUserByEmail(String email) {
        String sql = "SELECT * FROM [User] WHERE Email = ?";

        try {
            PreparedStatement st = connection.prepareStatement(sql);
            st.setString(1, email);
            ResultSet rs = st.executeQuery();
            while (rs.next()) {
                User userToAdd = new User(rs.getInt("UserID"),
                        rs.getString("Username"),
                        rs.getString("Password"),
                        rs.getString("FullName"),
                        rs.getString("Image"),
                        rs.getString("Phone"),
                        rs.getString("Email"),
                        rs.getDate("DateOfBirth"),
                        rs.getBoolean("Gender"),
                        rs.getString("Address"),
                        rs.getString("CCCD"),
                        rs.getInt("RoleID"),
                        rs.getBoolean("Status"),
                        getManagerForSeller(rs.getInt("ManageID")),
                        rs.getDate("CreatedAt"));
                return userToAdd;
            }
        } catch (SQLException e) {
        }

        return null;
    }
  public Customer getUserbyCid(int customerID) {
        try {
            String sql = "Select *\n"
                    + "from Customer c \n"
                    + "join [User] u on u.UserID = c.UserID\n"
                    + "where c.CustomerId =?";
            PreparedStatement st = connection.prepareStatement(sql);
            st.setInt(1, customerID);
            ResultSet rs = st.executeQuery();
            if (rs.next()) {
                Customer customer = new Customer();
                customer.setCustomerid(rs.getInt("CustomerId"));
                customer.setCreditscore(rs.getInt("CreditScore"));
                customer.setBalance(rs.getBigDecimal("Balance"));
                User user = new User(rs.getInt("UserID"),
                        rs.getString("Username"),
                        rs.getString("Password"),
                        rs.getString("FullName"),
                        rs.getString("Image"),
                        rs.getString("Phone"),
                        rs.getString("Email"),
                        rs.getDate("DateOfBirth"),
                        rs.getBoolean("Gender"),
                        rs.getString("Address"),
                        rs.getString("CCCD"),
                        rs.getInt("RoleID"),
                        rs.getBoolean("Status"),
                        getManagerForSeller(rs.getInt("ManageID")),
                        rs.getDate("CreatedAt"));
                customer.setUser(user);
                return customer;
            }
        } catch (Exception e) {
        }

        return null;
    }


    // duy
    public int addUserReturnRow(User userToAdd) {
        // Kiá»m tra trÃ¹ng láº·p Username, CCCD, Email, Phone trÆ°á»c khi thÃªm
        if (isUsernameExists(userToAdd.getUsername())) {
            return 2;
        }

        if (isCCCDExists(userToAdd.getCCCD())) {
            return 3;
        }

        if (isEmailExists(userToAdd.getEmail())) {
            return 4;
        }

        if (isPhoneExists(userToAdd.getPhone())) {
            return 5;
        }

        // Náº¿u khÃ´ng cÃ³ trÃ¹ng láº·p, thá»±c hiá»n thÃªm ngÆ°á»i dÃ¹ng má»i
        String sql = """
                 INSERT INTO [User](Username, Password, FullName, Image, Phone, Email, DateOfBirth, Gender, Address, CCCD, RoleID, Status, ManageID)
                 VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)""";

        try {
            PreparedStatement st = connection.prepareStatement(sql);
            st.setString(1, userToAdd.getUsername());
            st.setString(2, userToAdd.getPassword());
            st.setString(3, userToAdd.getFullName());
            st.setString(4, userToAdd.getImage());
            st.setString(5, userToAdd.getPhone());
            st.setString(6, userToAdd.getEmail());
            st.setDate(7, userToAdd.getDateOfBirth());
            st.setBoolean(8, userToAdd.isGender());
            st.setString(9, userToAdd.getAddress());
            st.setString(10, userToAdd.getCCCD());
            st.setInt(11, userToAdd.getRoleID());
            st.setBoolean(12, userToAdd.isStatus());

            // Náº¿u manager == null, Äáº·t ManageID lÃ  NULL
            if (userToAdd.getManager() != null) {
                st.setInt(13, userToAdd.getManager().getUserID());
            } else {
                st.setNull(13, java.sql.Types.INTEGER);
            }
            int row = st.executeUpdate();
            return row;
        } catch (SQLException e) {
            e.printStackTrace();
        }
        return 0;
    }

// kiá»m tra sá»± tá»n táº¡i cá»§a username
    private boolean isUsernameExists(String username) {
        String query = "SELECT COUNT(*) FROM [User] WHERE Username = ?";
        try (PreparedStatement stmt = connection.prepareStatement(query)) {
            stmt.setString(1, username);
            ResultSet rs = stmt.executeQuery();
            if (rs.next() && rs.getInt(1) > 0) {
                return true;
            }
        } catch (SQLException e) {
            e.printStackTrace();
        }
        return false;
    }

    // kiá»m tra sá»± tá»n táº¡i cá»§a CCCD
    private boolean isCCCDExists(String cccd) {
        String query = "SELECT COUNT(*) FROM [User] WHERE CCCD = ?";
        try (PreparedStatement stmt = connection.prepareStatement(query)) {
            stmt.setString(1, cccd);
            ResultSet rs = stmt.executeQuery();
            if (rs.next() && rs.getInt(1) > 0) {
                return true;
            }
        } catch (SQLException e) {
            e.printStackTrace();
        }
        return false;
    }

    // kiá»m tra sá»± tá»n táº¡i cá»§a Email
    private boolean isEmailExists(String email) {
        String query = "SELECT COUNT(*) FROM [User] WHERE Email = ?";
        try (PreparedStatement stmt = connection.prepareStatement(query)) {
            stmt.setString(1, email);
            ResultSet rs = stmt.executeQuery();
            if (rs.next() && rs.getInt(1) > 0) {
                return true;
            }
        } catch (SQLException e) {
            e.printStackTrace();
        }
        return false;
    }

    // kiá»m tra sá»± tá»n táº¡i cá»§a Phone
    private boolean isPhoneExists(String phone) {
        String query = "SELECT COUNT(*) FROM [User] WHERE Phone = ?";
        try (PreparedStatement stmt = connection.prepareStatement(query)) {
            stmt.setString(1, phone);
            ResultSet rs = stmt.executeQuery();
            if (rs.next() && rs.getInt(1) > 0) {
                return true;
            }
        } catch (SQLException e) {
            e.printStackTrace();
        }
        return false;
    }


     public User getUserByUserID(int userID) {
        String sql = "SELECT* FROM [dbo].[User] where [dbo].[User].UserID = ?";

        try {
            PreparedStatement st = connection.prepareStatement(sql);
            st.setInt(1, userID);
            ResultSet rs = st.executeQuery();
            while (rs.next()) {
                User user = new User(rs.getInt("UserID"),
                        rs.getString("Username"),
                        rs.getString("Password"),
                        rs.getString("FullName"),
                        rs.getString("Image"),
                        rs.getString("Phone"),
                        rs.getString("Email"),
                        rs.getDate("DateOfBirth"),
                        rs.getBoolean("Gender"),
                        rs.getString("Address"),
                        rs.getString("CCCD"),
                        rs.getInt("RoleID"),
                        rs.getBoolean("Status"),
                        getManagerForSeller(rs.getInt("ManageID")),
                        rs.getDate("CreatedAt"));
                return user;
            }

        } catch (SQLException e) {
            e.printStackTrace();
        }
        return null;
    }

    // update user vá»i vai trÃ² admin ( tráº£ vá» sá» hÃ ng bá» áº£nh hÆ°á»ng )
    public int updateUserByUserId2(User userToUpdate, int userId) {
        String sql = """
                     UPDATE [dbo].[User]
                        SET [Username] = ?
                           ,[FullName] = ?
                           ,[Image] = ?
                           ,[Phone] = ?
                           ,[Email] = ?
                           ,[DateOfBirth] = ?
                           ,[Gender] = ?
                           ,[Address] = ?
                           ,[CCCD] = ?
                           ,[RoleID] = ?
                           ,[ManageID] = ?
                      WHERE UserID = ?""";

        try {
            PreparedStatement st = connection.prepareStatement(sql);
            st.setString(1, userToUpdate.getUsername());
            st.setString(2, userToUpdate.getFullName());
            st.setString(3, userToUpdate.getImage());
            st.setString(4, userToUpdate.getPhone());
            st.setString(5, userToUpdate.getEmail());
            st.setDate(6, userToUpdate.getDateOfBirth());
            st.setBoolean(7, userToUpdate.isGender());
            st.setString(8, userToUpdate.getAddress());
            st.setString(9, userToUpdate.getCCCD());
            st.setInt(10, userToUpdate.getRoleID());

            // Náº¿u manager == null, Äáº·t ManageID lÃ  NULL
            if (userToUpdate.getManager() != null) {
                st.setInt(11, userToUpdate.getManager().getUserID());
            } else {
                st.setNull(11, java.sql.Types.INTEGER);
            }

            st.setInt(12, userId);
            int row = st.executeUpdate();
            if (row > 0) {
                return row;
            }
        } catch (SQLException e) {
            e.printStackTrace();
        }
        return 0;
    }

    //TÃ¬m kiáº¿m user dá»±a trÃªn keyword dc nháº­p vÃ o 
    public List<User> searchUsers(String keyword, int page, int pageSize) {
        List<User> listUsers = new ArrayList<>();

        String sql = """
         SELECT * FROM [dbo].[User] 
         JOIN [dbo].[Role] ON [dbo].[User].[RoleID] = [dbo].[Role].RoleID
         WHERE Username LIKE ? 
            OR FullName LIKE ? 
            OR Email LIKE ? 
            OR Phone LIKE ? 
            OR [DateOfBirth] LIKE ? 
            OR Gender = CASE 
                           WHEN ? = 'male' THEN 1 
                           WHEN ? = 'female' THEN 0 
                        END
            OR [CCCD] LIKE ? 
            OR RoleName LIKE ? 
            OR Address LIKE ?
            OR CONVERT(VARCHAR, CreatedAt, 120) LIKE ?
         ORDER BY [UserID] 
         OFFSET ? ROWS FETCH NEXT ? ROWS ONLY
    """;

        try (PreparedStatement st = connection.prepareStatement(sql)) {
            // Thiáº¿t láº­p tham sá» tÃ¬m kiáº¿m
            for (int i = 1; i <= 5; i++) {
                st.setString(i, "%" + keyword + "%");
            }
            st.setString(6, keyword); // Gender
            st.setString(7, keyword); // Gender
            st.setString(8, "%" + keyword + "%");
            st.setString(9, "%" + keyword + "%");
            st.setString(10, "%" + keyword + "%");
            st.setString(11, "%" + keyword + "%");

            // Thiáº¿t láº­p phÃ¢n trang
            st.setInt(12, (page - 1) * pageSize);
            st.setInt(13, pageSize);

            try (ResultSet rs = st.executeQuery()) {
                while (rs.next()) {
                    User user = new User(rs.getInt("UserID"),
                            rs.getString("Username"),
                            rs.getString("Password"),
                            rs.getString("FullName"),
                            rs.getString("Image"),
                            rs.getString("Phone"),
                            rs.getString("Email"),
                            rs.getDate("DateOfBirth"),
                            rs.getBoolean("Gender"),
                            rs.getString("Address"),
                            rs.getString("CCCD"),
                            rs.getInt("RoleID"),
                            rs.getBoolean("Status"),
                            getManagerForSeller(rs.getInt("ManageID")),
                            rs.getDate("CreatedAt"));

                    listUsers.add(user);
                }
            }
        } catch (SQLException e) {
            e.printStackTrace();
        }
        return listUsers;
    }


     // láº¥y ra tá»ng sá» lÆ°á»£ng user sau khi search user by keyword
    public int getTotalUsersAfterSearching(String keyword) {
        String sql = """
         SELECT COUNT(*) FROM [dbo].[User] 
         JOIN [dbo].[Role] ON [dbo].[User].[RoleID] = [dbo].[Role].RoleID
         WHERE Username LIKE ? 
            OR FullName LIKE ? 
            OR Email LIKE ? 
            OR Phone LIKE ? 
            OR [DateOfBirth] LIKE ? 
            OR Gender = CASE 
                           WHEN ? = 'male' THEN 1 
                           WHEN ? = 'female' THEN 0 
                        END
            OR [CCCD] LIKE ? 
            OR RoleName LIKE ? 
            OR CONVERT(VARCHAR, CreatedAt, 120) LIKE ?
    """;

        try (PreparedStatement stmt = connection.prepareStatement(sql)) {
            // Thiáº¿t láº­p tham sá» tÃ¬m kiáº¿m
            for (int i = 1; i <= 5; i++) {
                stmt.setString(i, "%" + keyword + "%");
            }
            stmt.setString(6, keyword); // Gender
            stmt.setString(7, keyword); // Gender
            stmt.setString(8, "%" + keyword + "%");
            stmt.setString(9, "%" + keyword + "%");
            stmt.setString(10, "%" + keyword + "%");

            try (ResultSet rs = stmt.executeQuery()) {
                if (rs.next()) {
                    return rs.getInt(1);
                }
            }
        } catch (SQLException ex) {
            ex.printStackTrace();
        }

        return 0;
    }

     // Sort list user by full name ( asc / des )
    public List<User> sortListUserByFullName(String typeOfSort, int page, int pageSize) {

        List<User> listUser = new ArrayList<>();
        String sql = "SELECT * FROM [dbo].[User] "
                + "ORDER BY FullName "
                + (typeOfSort.equalsIgnoreCase("asc") ? "ASC" : "DESC") + " "
                + "OFFSET ? ROWS FETCH NEXT ? ROWS ONLY";

        try {
            PreparedStatement st = connection.prepareStatement(sql);
            st.setInt(1, (page - 1) * pageSize); // TÃ­nh sá» dÃ²ng cáº§n bá» qua
            st.setInt(2, pageSize); // Sá» lÆ°á»£ng user trÃªn má»i trang

            ResultSet rs = st.executeQuery();

            while (rs.next()) {
                User user = new User(rs.getInt("UserID"),
                        rs.getString("Username"),
                        rs.getString("Password"),
                        rs.getString("FullName"),
                        rs.getString("Image"),
                        rs.getString("Phone"),
                        rs.getString("Email"),
                        rs.getDate("DateOfBirth"),
                        rs.getBoolean("Gender"),
                        rs.getString("Address"),
                        rs.getString("CCCD"),
                        rs.getInt("RoleID"),
                        rs.getBoolean("Status"),
                        getManagerForSeller(rs.getInt("ManageID")),
                        rs.getDate("CreatedAt"));
                listUser.add(user);
            }
        } catch (SQLException e) {
            e.printStackTrace();
        }
        return listUser;
    }

     // Sort list user by created date ( asc / des )
    public List<User> sortListUserByCreatedAt(String typeOfSort, int page, int pageSize) {
        String sql;
        List<User> listUser = new ArrayList<>();

        if (typeOfSort.equalsIgnoreCase("asc")) {
            sql = "SELECT * FROM [dbo].[User] ORDER BY CreatedAt ASC OFFSET ? ROWS FETCH NEXT ? ROWS ONLY";
        } else {
            sql = "SELECT * FROM [dbo].[User] ORDER BY CreatedAt DESC OFFSET ? ROWS FETCH NEXT ? ROWS ONLY";
        }

        try {
            PreparedStatement st = connection.prepareStatement(sql);
            st.setInt(1, (page - 1) * pageSize); // TÃ­nh sá» dÃ²ng cáº§n bá» qua
            st.setInt(2, pageSize); // Sá» lÆ°á»£ng user trÃªn má»i trang
            ResultSet rs = st.executeQuery();

            while (rs.next()) {
                User user = new User(rs.getInt("UserID"),
                        rs.getString("Username"),
                        rs.getString("Password"),
                        rs.getString("FullName"),
                        rs.getString("Image"),
                        rs.getString("Phone"),
                        rs.getString("Email"),
                        rs.getDate("DateOfBirth"),
                        rs.getBoolean("Gender"),
                        rs.getString("Address"),
                        rs.getString("CCCD"),
                        rs.getInt("RoleID"),
                        rs.getBoolean("Status"),
                        getManagerForSeller(rs.getInt("ManageID")),
                        rs.getDate("CreatedAt"));
                listUser.add(user);
            }
        } catch (SQLException e) {
            e.printStackTrace();
        }
        return listUser;
    }


      // Filter list user by Role name
    public List<User> filterListUserByRoleName(int idOfRole, int page, int pageSize) {

        List<User> listUser = new ArrayList<>();
        String sql = """
                     SELECT * 
                     FROM [dbo].[User] 
                     WHERE RoleID = ?
                     ORDER BY [UserID]
                     OFFSET ? ROWS FETCH NEXT ? ROWS ONLY;""";

        try {
            PreparedStatement st = connection.prepareStatement(sql);

            st.setInt(1, idOfRole);
            st.setInt(2, (page - 1) * pageSize); // TÃ­nh sá» dÃ²ng cáº§n bá» qua
            st.setInt(3, pageSize); // Sá» lÆ°á»£ng user trÃªn má»i trang

            ResultSet rs = st.executeQuery();

            while (rs.next()) {
                User user = new User(rs.getInt("UserID"),
                        rs.getString("Username"),
                        rs.getString("Password"),
                        rs.getString("FullName"),
                        rs.getString("Image"),
                        rs.getString("Phone"),
                        rs.getString("Email"),
                        rs.getDate("DateOfBirth"),
                        rs.getBoolean("Gender"),
                        rs.getString("Address"),
                        rs.getString("CCCD"),
                        rs.getInt("RoleID"),
                        rs.getBoolean("Status"),
                        getManagerForSeller(rs.getInt("ManageID")),
                        rs.getDate("CreatedAt"));
                listUser.add(user);
            }
        } catch (SQLException e) {
            e.printStackTrace();
        }
        return listUser;
    }


     // láº¥y ra tá»ng sá» user sau lá»c báº±ng role name
    public int getTotalUsersAfterFilteringByRole(int roleId) {
        String sql = "SELECT count(*) FROM [dbo].[User] WHERE RoleID = ?";

        try {
            PreparedStatement stmt = connection.prepareStatement(sql);
            stmt.setInt(1, roleId);
            ResultSet rs = stmt.executeQuery();

            if (rs.next()) {
                return rs.getInt(1);
            }
        } catch (SQLException ex) {
            ex.printStackTrace();
        }

        return 0;
    }

     // Filter list user by Status ( idOfStatus = 1 / 0 ( active / inactive )
    public List<User> filterListUserByStatus(int idOfStatus, int page, int pageSize) {

        List<User> listUser = new ArrayList<>();
        String sql = """
                     SELECT * 
                     FROM [dbo].[User] 
                     WHERE Status = ?
                     ORDER BY [UserID]
                     OFFSET ? ROWS FETCH NEXT ? ROWS ONLY;""";

        try {
            PreparedStatement st = connection.prepareStatement(sql);

            st.setInt(1, idOfStatus);
            st.setInt(2, (page - 1) * pageSize); // TÃ­nh sá» dÃ²ng cáº§n bá» qua
            st.setInt(3, pageSize); // Sá» lÆ°á»£ng user trÃªn má»i trang

            ResultSet rs = st.executeQuery();

            while (rs.next()) {
                User user = new User(rs.getInt("UserID"),
                        rs.getString("Username"),
                        rs.getString("Password"),
                        rs.getString("FullName"),
                        rs.getString("Image"),
                        rs.getString("Phone"),
                        rs.getString("Email"),
                        rs.getDate("DateOfBirth"),
                        rs.getBoolean("Gender"),
                        rs.getString("Address"),
                        rs.getString("CCCD"),
                        rs.getInt("RoleID"),
                        rs.getBoolean("Status"),
                        getManagerForSeller(rs.getInt("ManageID")),
                        rs.getDate("CreatedAt"));
                listUser.add(user);
            }
        } catch (SQLException e) {
            e.printStackTrace();
        }
        return listUser;
    }


     // láº¥y ra tá»ng sá» user sau lá»c báº±ng Status
    public int getTotalUsersAfterFilteringByStatus(int idOfStatus) {
        String sql = "SELECT count(*) FROM [dbo].[User] WHERE Status = ?";

        try {
            PreparedStatement stmt = connection.prepareStatement(sql);
            stmt.setInt(1, idOfStatus);
            ResultSet rs = stmt.executeQuery();

            if (rs.next()) {
                return rs.getInt(1);
            }
        } catch (SQLException ex) {
            ex.printStackTrace();
        }

        return 0;
    }
     //Láº¥y ra list user tá»« trang hiá»n táº¡i
    public ArrayList<User> getListUserByPage(int page, int pageSize) {
        // page: sá» trang hiá»n táº¡i
        // pageSize: sá» lÆ°á»£ng user cÃ³ trong 1 trang
        ArrayList<User> listUser = new ArrayList<>();

        String sql = "select * from [User] order by [UserID] offset ? rows fetch next ? rows only";
        // offset ? rows:    Bá» qua má»t sá» dÃ²ng dá»±a trÃªn sá» trang.
        // fetch next ? rows only:  Láº¥y tiáº¿p sá» dÃ²ng tÆ°Æ¡ng á»©ng vá»i pageSize.

        try {
            PreparedStatement stmt = connection.prepareStatement(sql);

            stmt.setInt(1, (page - 1) * pageSize);
            // (page - 1) * pageSize: TÃ­nh sá» dÃ²ng cáº§n bá» qua dá»±a trÃªn sá» trang hiá»n táº¡i

            /* vÃ­ dá»¥:   page = 1, pageSize = 10 â offset = (1-1) * 10 = 0 (láº¥y tá»« dÃ²ng Äáº§u tiÃªn).
                        page = 2, pageSize = 10 â offset = (2-1) * 10 = 10 (bá» qua 10 dÃ²ng Äáº§u).*/
            stmt.setInt(2, pageSize);

            ResultSet rs = stmt.executeQuery();

            while (rs.next()) {
                User user = new User(rs.getInt("UserID"),
                        rs.getString("Username"),
                        rs.getString("Password"),
                        rs.getString("FullName"),
                        rs.getString("Image"),
                        rs.getString("Phone"),
                        rs.getString("Email"),
                        rs.getDate("DateOfBirth"),
                        rs.getBoolean("Gender"),
                        rs.getString("Address"),
                        rs.getString("CCCD"),
                        rs.getInt("RoleID"),
                        rs.getBoolean("Status"),
                        getManagerForSeller(rs.getInt("ManageID")),
                        rs.getDate("CreatedAt"));
                listUser.add(user);

            }
        } catch (SQLException ex) {
            ex.printStackTrace();
        }

        return listUser;
    }


      // láº¥y ra tá»ng sá» user hiá»n Äang cÃ³
    public int getTotalUsers() {
        String sql = "select count(*) from [User]";

        try {
            PreparedStatement stmt = connection.prepareStatement(sql);
            ResultSet rs = stmt.executeQuery();

            if (rs.next()) {
                return rs.getInt(1);
            }
        } catch (SQLException ex) {
            ex.printStackTrace();
        }

        return 0;
    }

    //tÃ­nh tá»ng sá» lÆ°á»£ng cá»§a user theo tá»«ng Role 
    public int getTotalUsersOfEachRole(String roleOfUser) {

        String sql = "";
        switch (roleOfUser) {
            case "Admin" ->
                sql = "select count(*) from [dbo].[User] where RoleID = '1' ";
            case "Seller" ->
                sql = "select count(*) from [dbo].[User] where RoleID = '2' ";
            case "Manager" ->
                sql = "select count(*) from [dbo].[User] where RoleID = '3' ";
            case "Provider Insurance" ->
                sql = "select count(*) from [dbo].[User] where RoleID = '4' ";
            case "Customer" ->
                sql = "select count(*) from [dbo].[User] where RoleID = '5' ";
        }
        try {
            PreparedStatement stmt = connection.prepareStatement(sql);
            ResultSet rs = stmt.executeQuery();

            if (rs.next()) {
                return rs.getInt(1);
            }
        } catch (SQLException ex) {
            ex.printStackTrace();
        }
        return 0;
    }

    // update status of users ( active / inactive )
    public boolean updateStatusOfUsers(int userID, boolean statusIsChecked) {
        String query = """
                       UPDATE [dbo].[User]
                          SET [Status] = ?     
                        WHERE [UserID] = ? """;
        try {
            PreparedStatement stmt = connection.prepareStatement(query);
            stmt.setBoolean(1, statusIsChecked);
            stmt.setInt(2, userID);

            int rowsUpdated = stmt.executeUpdate();
            return rowsUpdated > 0;
        } catch (SQLException e) {
            e.printStackTrace();
            return false;
        }
    }
}
